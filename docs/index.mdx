---
name: 开始
route: /
---

import { Playground } from 'docz';
import Form, {
  useFormState,
  FormItem,
  Field,
  Label,
  FormStateContext,
} from '../src';

# 表单状态管理

安装：

```shell
yarn add sinoui-forms
```

或

```shell
npm install --save sinoui-forms
```

引用：

```ts
import Form, { useFormState, FormItem, Field, Label } from 'sinoui-forms';
```

源码路径：[https://github.com/sinoui/sinoui-forms](https://github.com/sinoui/sinoui-forms)。

表单状态管理 hook(`useFormState`)提供以下功能：

- 表单值处理
- 表单校验
  - 表单级别的校验
  - 表单域级别的校验（包括同步和异步）
- 自定义表单域
- 一次性设置多个表单域的值
- 表单域值关联
- 表单提交
- 嵌套表单，包括简单的嵌套表单和复杂的嵌套表单，复杂的嵌套表单需要和`useFieldArray`结合才能实现

下面我们通过例子来了解表单状态管理几个主要功能的基本用法。

## 表单值处理

基本用法：

```tsx
import React from 'react';
import Form, { useFormState, FormItem, Field, Label } from 'sinoui-forms';

function FormDemo() {
  const defaultValues = {};
  const formState = useFormState(defaultValues);

  return (
    <Form formState={formState}>
      <FormItem>
        <Label>用户名</Label>
        <Field as="input" name="userName" />
      </FormItem>
      <FormItem>
        <Label>密码</Label>
        <Field as="input" name="password" compProps={{ type: 'password' }} />
      </FormItem>
      <div>表单值：{JSON.stringify(formState.values, undefined, 2)}</div>
    </Form>
  );
}
```

运行效果：

<Playground>
  {
    ()=>{
      const defaultValues = {};
      const formState = useFormState(defaultValues);

      return (
        <Form formState={formState}>
          <FormItem>
            <Label>用户名</Label>
            <Field as="input" name="userName" />
          </FormItem>
          <FormItem>
            <Label>密码</Label>
            <Field as="input" name="password" compProps={{ type: 'password' }} />
            </FormItem>
          <div>表单值：{JSON.stringify(formState.values, undefined, 2)}</div>
        </Form>
      );
    }

}

</Playground>

## 表单校验

可以在使用`useFormState`时，传入第二个对象参数，在里面指定表单全局校验规则;
可以给`Field`组件指定`validate`属性，做表单域级别的同步校验，指定`asyncValidate`属性指定表单域级别的异步校验规则。
其中，表单域级别的同步校验，有几个常用属性：

- required 必填校验
- trimRequired 去掉首尾空白符之后的必填校验
- min 指定数值，做最小值校验
- max 指定数值，做最大值校验
- maxLength 指定数值，做字符串最大长度校验
- minLength 指定数值，做字符串最小长度校验
- pattern 正则校验
- patternErrorMessage 正则校验失败的错误信息

基本用法：

```tsx
import React from 'react';
import Form, { FormItem, Field, Label, useFormState } from 'sinoui-forms';

/**
 * 定义全局表单校验规则
 */

function validate(values: any) {
  let error: any = {};

  if (values.userName) {
    const arr = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
    if (arr.findIndex((item) => values.userName.startsWith(item)) !== -1) {
      error['userName'] = '不能以数字开头';
    }
  }

  return error;
}

function FormDemo() {
  const defaultValues = {};
  const formState = useFormState(defaultValues, { validate });

  return (
    <Form formState={formState}>
      <FormItem>
        <Label>用户名</Label>
        <Field as="input" name="userName" required />
      </FormItem>
      <FormItem>
        <Label>密码</Label>
        <Field
          as="input"
          name="password"
          required
          minLength={8}
          compProps={{ type: 'password' }}
        />
      </FormItem>
    </Form>
  );
}
```

运行效果：

<Playground>
  {()=>{
    function validate(values) {
      let error = {};

      if (values.userName) {
        const arr = ['0','1','2','3','4','5','6','7','8','9'];
        if (arr.findIndex(item=>values.userName.startsWith(item)) !==-1) {
            error['userName'] = '不能以数字开头';
        }
      }
      return error;
    }

    const defaultValues = {};
    const formState = useFormState(defaultValues, { validate });

    return (
      <Form formState={formState}>
        <FormItem>
          <Label>用户名</Label>
          <Field as="input" name="userName" required />
        </FormItem>
        <FormItem>
          <Label>密码</Label>
          <Field
            as="input"
            name="password"
            required
            minLength={8}
            compProps={{ type: 'password' }}
          />
        </FormItem>
      </Form>
    );

}}

</Playground>

## 自定义表单域

在自定义表单域时，如果表单域有子节点，我们可以给`Field`组件指定`children`,
同时我们还能给`Field`组件指定一个`compProps`的对象属性，来指定表单域组件的其它属性。

基本用法：

`Select.tsx`

```tsx
import React from 'react';
import { Field } from 'sinoui-forms';

function Select(props) {
  return (
    <Field as="select" {...props}>
      {props.children}
    </Field>
  );
}

export default Select;
```

`FormDemo.tsx`

```tsx
import React from 'react';
import Form, { FormItem, Field, Label, useFormState } from 'sinoui-forms';
import Select from './Select';

function FormDemo() {
  const defaultValues = {};
  const formState = useFormState(defaultValues);

  return (
    <Form formState={formState}>
      <FormItem>
        <Label>姓名</Label>
        <Field as="input" name="userName" />
      </FormItem>
      <FormItem>
        <Label>所在城市</Label>
        <Select name="city" compProps={{ style: { width: 160 } }}>
          <option value="北京">北京</option>
          <option value="上海">上海</option>
          <option value="广州">广州</option>
          <option value="深圳">深圳</option>
        </Select>
      </FormItem>
    </Form>
  );
}
```

运行效果：

<Playground>
  {()=>{
    const formState = useFormState({});

    return (
      <Form formState={formState}>
        <FormItem>
          <Label>姓名</Label>
          <Field as="input" name="userName" />
        </FormItem>
        <FormItem>
          <Label>所在城市</Label>
          <Field as="select" name="city" compProps={{ style: { width: 160 } }}>
            <option value="北京">北京</option>
            <option value="上海">上海</option>
            <option value="广州">广州</option>
            <option value="深圳">深圳</option>
          </Field>
        </FormItem>
      </Form>
    )

}}

</Playground>

## 一次性设置多个表单域的值

对于需要一次性设置多个表单域值的需求，我们为`Field`提供了另一种`render`的渲染方式。使用时只需要给`Field`组件指定一个
`render`属性，指定表单域的渲染内容，监听表单域的 onChange 事件，多次调用表单设置值的方法就能同时设置多个表单域的值。

基本用法：

```tsx
import React from 'react';
import Form, { FormItem, Field, Label, useFormState } from 'sinoui-forms';

function FormDemo() {
  const defaultValues = {};
  const formState = useFormState(defaultValues);

  return (
    <Form formState={formState}>
      <FormItem>
        <Label>公文标题</Label>
        <Field as="input" name="title" />
      </FormItem>
      <FormItem>
        <Label>紧急程度</Label>
        <Field
          name="jjcd"
          render={({ setFieldValue, id, name }) => {
            return (
              <select
                style={{ width: 160 }}
                onChange={(event) => {
                  setFieldValue('jjcdNum', event.target.value);
                  setFieldValue('jjcd', event.target.selectedOptions[0].label);
                }}
              >
                <option value="001">急</option>
                <option value="002">特急</option>
                <option value="003">限时</option>
                <option value="004">特提</option>
              </select>
            );
          }}
        />
      </FormItem>
      <div>表单值：{JSON.stringify(formState.values, undefined, 2)}</div>
    </Form>
  );
}
```

运行效果：

<Playground>
  {() => {
    const formState = useFormState({});
    return (
      <Form formState={formState}>
        <FormItem>
          <Label>公文标题</Label>
          <Field as="input" name="title" />
        </FormItem>
        <FormItem>
          <Label>紧急程度</Label>
          <Field
            name="jjcd"
            render={({ setFieldValue, id, name }) => {
              return (
                <select
                  style={{ width: 160 }}
                  onChange={(event) => {
                    setFieldValue('jjcdNum', event.target.value);
                    setFieldValue(
                      'jjcd',
                      event.target.selectedOptions[0].label,
                    );
                  }}
                >
                  <option value="001">急</option>
                  <option value="002">特急</option>
                  <option value="003">限时</option>
                  <option value="004">特提</option>
                </select>
              );
            }}
          />
        </FormItem>
        <div>表单值：{JSON.stringify(formState.values, undefined, 2)}</div>
      </Form>
    );
  }}
</Playground>

## 表单域值关联

我们可以给`Field`组件指定`relyFieldsName`属性表示跟哪个表单域关联，同时指定`relyFn`函数属性定义依赖规则。

```tsx
import React from 'react';
import Form, { FormItem, Field, Label, useFormState } from 'sinoui-forms';

function relyFn(values) {
  if (!values.firstName) {
    return values.lastName || '';
  }

  if (!values.lastName) {
    return values.firstName || '';
  }

  return `${values.firstName}${values.lastName}`;
}

function FormDemo() {
  const defaultValues = {};
  const formState = useFormState(defaultValues, {});

  return (
    <Form formState={formState}>
      <FormItem>
        <Label>姓氏</Label>
        <Field as="input" name="firstName" />
      </FormItem>
      <FormItem>
        <Label>名字</Label>
        <Field as="input" name="lastName" />
      </FormItem>

      <FormItem>
        <Label>用户名</Label>
        <Field
          as="input"
          name="userName"
          relyFieldsName={['firstName', 'lastName']}
          relyFn={relyFn}
          compProps={{ disabled: true }}
        />
      </FormItem>
      <div>表单值：{JSON.stringify(formState.values, undefined, 2)}</div>
    </Form>
  );
}
```

运行效果：

<Playground>
  {()=>{
    function relyFn(values) {
      if (!values.firstName) {
        return values.lastName || '';
      }

      if (!values.lastName) {
        return values.firstName || '';
      }

      return `${values.firstName}${values.lastName}`;
    }

    const formState = useFormState({});

    return (
      <Form formState={formState}>
        <FormItem>
          <Label>姓氏</Label>
          <Field as="input" name="firstName" />
        </FormItem>
        <FormItem>
          <Label>名字</Label>
          <Field as="input" name="lastName" />
        </FormItem>

        <FormItem>
          <Label>用户名</Label>
          <Field
            as="input"
            name="userName"
            relyFieldsName={['firstName', 'lastName']}
            relyFn={relyFn}
            compProps={{ disabled: true }}
          />
        </FormItem>
        <div>表单值：{JSON.stringify(formState.values, undefined, 2)}</div>
      </Form>
    )

}}

</Playground>

## 表单提交

调用`formState.onSubmit()`方法实现表单提交。

基本用法：

```tsx
import React from 'react';
import Form, { FormItem, Field, Label, useFormState } from 'sinoui-forms';
import http from '@sinoui/http';

function validate(values: any) {
  let error: any = {};

  if (values.userName) {
    const arr = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
    if (arr.findIndex((item) => values.userName.startsWith(item)) !== -1) {
      error['userName'] = '不能以数字开头';
    }
  }

  return error;
}

/**
 * 表单提交处理
 */

const onSubmit = (values: any) => {
  http.post('/test/login', values);
};

function FormDemo() {
  const defaultValues = {};
  const formState = useFormState(defaultValues, { validate, onSubmit });

  return (
    <Form formState={formState} onSubmit={formState.onSubmit}>
      <FormItem>
        <Label>用户名</Label>
        <Field as="input" name="userName" required />
      </FormItem>
      <FormItem>
        <Label>密码</Label>
        <Field
          as="input"
          name="password"
          required
          minLength={8}
          compProps={{ type: 'password' }}
        />
      </FormItem>
      <button type="submit">登录</button>
    </Form>
  );
}
```

运行效果：

<Playground>
  {()=>{
    function validate(values) {
      let error = {};

      if (values.userName) {
        const arr = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
        if (arr.findIndex((item) => values.userName.startsWith(item)) !== -1) {
          error['userName'] = '不能以数字开头';
        }
      }

      return error;
    }

    const onSubmit = (values) => {
      alert(`要提交的表单值为：${JSON.stringify(values)}`);
    };

     const formState = useFormState({}, { validate, onSubmit });

     return (
       <Form formState={formState} onSubmit={formState.onSubmit}>
        <FormItem>
          <Label>用户名</Label>
          <Field as="input" name="userName" required />
        </FormItem>
        <FormItem>
          <Label>密码</Label>
          <Field
            as="input"
            name="password"
            required
            minLength={8}
            compProps={{ type: 'password' }}
          />
        </FormItem>
        <button type="submit">登录</button>
      </Form>
     )

}}

</Playground>

## 嵌套表单

简单的嵌套表单我们只需要在指定 name 时，做些处理就行，复杂的嵌套表单(可编辑数据行),则需要结合`useFieldArray`来实现。下面我们以一个简单的示例来说明具体使用方式：

`TelePhoneForm.tsx`

```tsx
import React from 'react';
import { Field, FormItem, useFieldArray } from 'sinoui-forms';

function TelephoneForm() {
  const {
    getFieldName: name,
    items,
    insert,
    remove,
    push,
    swap,
  } = useFieldArray<any>('telephones');

  return (
    <div style={{ padding: 16 }}>
      <label>联系电话</label>
      {items.map((_telephone, index) => (
        <div
          key={index}
          style={{
            display: 'flex',
            padding: 8,
            border: '1px solid green',
            marginTop: 8,
            marginBottom: 8,
          }}
        >
          <FormItem>
            <Field
              name={name(index, 'type')}
              as="input"
              required
              compProps={{
                placeholder: '电话类型',
              }}
            />
          </FormItem>
          <FormItem>
            <Field
              name={name(index, 'telephone')}
              as="input"
              required
              minlength={4}
              compProps={{
                placeholder: '电话号码',
              }}
            />
          </FormItem>
          <button onClick={() => insert(index + 1, {})}>+</button>
          <button onClick={() => remove(index)}>-</button>
          {index > 0 && (
            <button onClick={() => swap(index, index - 1)}>⬆️</button>
          )}
          {index < items.length - 1 && (
            <button onClick={() => swap(index, index + 1)}>⬇️</button>
          )}
        </div>
      ))}
      <button onClick={() => push({})}>+</button>
    </div>
  );
}

export default TelephoneForm;
```

`FormDemo.tsx`

```tsx
import React from 'react';
import useFormState, {
  FormItem,
  Field,
  Label,
  FormStateContext,
} from 'sinoui-forms';
import TelephoneForm from './TelephoneForm';

function FormDemo() {
  const defaultValues = {};
  const formState = useFormState(defaultValues, {});

  return (
    <FormStateContext.Provider value={formState}>
      <FormItem>
        <Label>姓名</Label>
        <Field as="input" name="userName" />
      </FormItem>
      <div>
        <label>地址</label>
        <FormItem>
          <Label>城市</Label>
          <Field
            as="select"
            name="address.city"
            compProps={{ style: { width: 160 } }}
          >
            <option value="北京">北京</option>
            <option value="上海">上海</option>
            <option value="广州">广州</option>
            <option value="深圳">深圳</option>
          </Field>
        </FormItem>
        <FormItem>
          <Label>街道</Label>
          <Field as="input" name="address.street" required />
        </FormItem>
      </div>
      <TelePhoneForm />
      <div>表单值：{JSON.stringify(formState.values, undefined, 2)}</div>
    </FormStateContext.Provider>
  );
}
```
